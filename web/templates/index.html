<!-- @format -->

<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>数据集生成工具</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
      rel="stylesheet"
    />
    <style>
      .form-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .parameter-section {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
      }
      .loading {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }
      .loading-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        text-align: center;
      }
      .file-name {
        margin-top: 5px;
        font-size: 0.875rem;
        color: #6c757d;
      }
    </style>
  </head>
  <body>
    <div class="container form-container">
      <h1 class="text-center mb-4">数据集生成工具</h1>

      <form id="datasetForm" enctype="multipart/form-data">
        <!-- 基本参数 -->
        <div class="parameter-section">
          <h3>基本参数</h3>
          <div class="mb-3">
            <label for="save_folder" class="form-label"
              >保存文件夹路径（相对于项目根目录）</label
            >
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                id="save_folder"
                name="save_folder"
                value="data/dataset"
                placeholder="请输入相对于项目根目录的路径，例如: datasets"
              />
              <button
                class="btn btn-outline-secondary"
                type="button"
                onclick="selectSaveFolder()"
              >
                选择文件夹
              </button>
            </div>
          </div>

          <div class="mb-3">
            <label for="video_file" class="form-label">视频文件</label>
            <input
              type="file"
              class="form-control"
              id="video_file"
              name="video_file"
              accept=".mp4,.avi,.mov"
              required
            />
          </div>

          <div class="mb-3">
            <label class="form-label">是否为泥石流视频</label>
            <div class="form-check">
              <input
                class="form-check-input"
                type="radio"
                name="is_debrisflow"
                id="is_debrisflow_true"
                value="1"
              />
              <label class="form-check-label" for="is_debrisflow_true"
                >是</label
              >
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="radio"
                name="is_debrisflow"
                id="is_debrisflow_false"
                value="0"
                checked
              />
              <label class="form-check-label" for="is_debrisflow_false"
                >否</label
              >
            </div>
          </div>

          <div class="mb-3">
            <label for="data_type" class="form-label">数据集类型</label>
            <select class="form-select" id="data_type" name="data_type">
              <option value="train">训练集</option>
              <option value="val">验证集</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">是否使用SAM进行分割</label>
            <div class="form-check">
              <input
                class="form-check-input"
                type="radio"
                name="use_sam"
                id="use_sam_true"
                value="1"
                checked
                onchange="toggleSamOptions()"
              />
              <label class="form-check-label" for="use_sam_true">是</label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="radio"
                name="use_sam"
                id="use_sam_false"
                value="0"
                onchange="toggleSamOptions()"
              />
              <label class="form-check-label" for="use_sam_false"
                >否（仅保存提取的视频和最后一帧图片）</label
              >
            </div>
          </div>
        </div>

        <!-- 视频处理参数 -->
        <div class="parameter-section">
          <h3>视频处理参数</h3>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="frame_idx" class="form-label">帧索引</label>
              <input
                type="number"
                class="form-control"
                id="frame_idx"
                name="frame_idx"
                value="100"
                min="0"
              />
            </div>
            <div class="col-md-4 mb-3">
              <label for="slice_windows_size" class="form-label"
                >切片窗口大小</label
              >
              <input
                type="number"
                class="form-control"
                id="slice_windows_size"
                name="slice_windows_size"
                value="75"
                min="1"
              />
            </div>
            <div class="col-md-4 mb-3">
              <label for="extract_freq" class="form-label">提取频率</label>
              <input
                type="number"
                class="form-control"
                id="extract_freq"
                name="extract_freq"
                value="1"
                min="1"
              />
            </div>
          </div>
        </div>

        <!-- SAM模型参数 -->
        <div class="parameter-section" id="samParametersSection">
          <h3>SAM模型参数</h3>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="sam_model_type" class="form-label">模型类型</label>
              <select
                class="form-select"
                id="sam_model_type"
                name="sam_model_type"
              >
                <option value="vit_h">vit_h</option>
                <option value="vit_l">vit_l</option>
                <option value="vit_b">vit_b</option>
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="sam_model_device" class="form-label">运行设备</label>
              <select
                class="form-select"
                id="sam_model_device"
                name="sam_model_device"
              >
                <option value="cuda">CUDA</option>
                <option value="cpu">CPU</option>
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="sam_checkpoint" class="form-label"
                >检查点路径（相对于项目根目录）</label
              >
              <div class="input-group">
                <input
                  type="text"
                  class="form-control"
                  id="sam_checkpoint"
                  name="sam_checkpoint"
                  value="models/pretrained/sam/sam_vit_h_4b8939.pth"
                  placeholder="请输入相对于项目根目录的路径，例如: checkpoints/sam_vit_h.pth"
                />
                <button
                  class="btn btn-outline-secondary"
                  type="button"
                  onclick="selectCheckpointFile()"
                >
                  选择文件
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- 其他选项 -->
        <div class="parameter-section">
          <h3>其他选项</h3>
          <div class="mb-3 form-check">
            <input
              type="checkbox"
              class="form-check-input"
              id="show_photo"
              name="show_photo"
            />
            <label class="form-check-label" for="show_photo"
              >显示处理过程中的图片</label
            >
          </div>

          <div class="row" id="pointCoordinatesSection">
            <div class="col-md-6 mb-3">
              <label for="point_x" class="form-label">点坐标 X（可选）</label>
              <input
                type="number"
                class="form-control"
                id="point_x"
                name="point_x"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="point_y" class="form-label">点坐标 Y（可选）</label>
              <input
                type="number"
                class="form-control"
                id="point_y"
                name="point_y"
              />
            </div>
          </div>
        </div>

        <div class="text-center">
          <button type="submit" class="btn btn-primary btn-lg">
            开始生成数据集
          </button>
        </div>
      </form>
    </div>

    <!-- 加载动画 -->
    <div id="loading" class="loading">
      <div class="loading-content">
        <div class="spinner-border text-light" role="status">
          <span class="visually-hidden">加载中...</span>
        </div>
        <h4 class="mt-3 text-light">正在生成数据集，请稍候...</h4>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
      // 控制SAM相关选项的显示与隐藏
      function toggleSamOptions() {
        const useSam = document.getElementById('use_sam_true').checked;
        const samSection = document.getElementById('samParametersSection');
        const pointSection = document.getElementById('pointCoordinatesSection');

        if (useSam) {
          samSection.style.display = 'block';
          pointSection.style.display = 'block';
        } else {
          samSection.style.display = 'none';
          pointSection.style.display = 'none';
        }
      }

      // 初始调用一次来设置初始状态
      toggleSamOptions();

      // 文件夹选择函数
      function selectSaveFolder() {
        // 由于浏览器限制，无法直接获取文件夹路径
        // 让用户手动输入
        const folderPath = prompt(
          '请输入相对于项目根目录的保存文件夹路径',
          document.getElementById('save_folder').value
        );
        if (folderPath) {
          document.getElementById('save_folder').value = folderPath;
        }
      }

      // 检查点文件选择函数
      function selectCheckpointFile() {
        // 由于浏览器限制，无法直接获取文件完整路径
        // 让用户手动输入
        const filePath = prompt(
          '请输入相对于项目根目录的检查点文件路径',
          document.getElementById('sam_checkpoint').value
        );
        if (filePath) {
          document.getElementById('sam_checkpoint').value = filePath;
        }
      }

      document
        .getElementById('datasetForm')
        .addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const loading = document.getElementById('loading');

          try {
            loading.style.display = 'block';

            const response = await fetch('/generate_dataset', {
              method: 'POST',
              body: formData,
            });

            const result = await response.json();

            if (response.ok) {
              Toastify({
                text: result.message,
                duration: 3000,
                gravity: 'top',
                position: 'right',
                backgroundColor: '#28a745',
              }).showToast();
            } else {
              throw new Error(result.error || '生成数据集失败');
            }
          } catch (error) {
            Toastify({
              text: error.message,
              duration: 3000,
              gravity: 'top',
              position: 'right',
              backgroundColor: '#dc3545',
            }).showToast();
          } finally {
            loading.style.display = 'none';
          }
        });
    </script>
  </body>
</html>
